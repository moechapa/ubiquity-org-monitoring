<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>61.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <assignments>
        <name>Add_Opp_to_Null_Forecast</name>
        <label>Add Opp to Null Forecast</label>
        <locationX>446</locationX>
        <locationY>1008</locationY>
        <assignmentItems>
            <assignToReference>NeedForecastReset</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Addition_Loop</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>oppRemovePositions</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>oppRecIndex</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Addition_Loop</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>index</name>
        <label>index++</label>
        <locationX>358</locationX>
        <locationY>684</locationY>
        <assignmentItems>
            <assignToReference>oppRecIndex</assignToReference>
            <operator>Add</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Opp_in_correct_forecast</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Mark_Opp_for_Reset</name>
        <label>Mark Opp for Reset</label>
        <locationX>446</locationX>
        <locationY>900</locationY>
        <assignmentItems>
            <assignToReference>Addition_Loop.Forecast__c</assignToReference>
            <operator>Assign</operator>
        </assignmentItems>
        <connector>
            <targetReference>Add_Opp_to_Null_Forecast</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Remove_Bad_Opps_From_Related</name>
        <label>Remove Bad Opps From Related</label>
        <locationX>270</locationX>
        <locationY>1392</locationY>
        <assignmentItems>
            <assignToReference>OppRecs</assignToReference>
            <operator>RemovePosition</operator>
            <value>
                <elementReference>Opp_Removal_Loop</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Opp_Removal_Loop</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>After running calc, do we need to update actuals</description>
        <name>Check_if_forecast_needs_update</name>
        <label>Check if forecast needs update</label>
        <locationX>182</locationX>
        <locationY>1692</locationY>
        <defaultConnector>
            <targetReference>Opps_to_reset_check</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Update_actuals</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>need2UpdateForecast</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Commit_forecast_update</targetReference>
            </connector>
            <label>Update actuals</label>
        </rules>
    </decisions>
    <decisions>
        <name>Current_Forecast_Check</name>
        <label>Current Forecast Check</label>
        <locationX>776</locationX>
        <locationY>252</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Date_Valid</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.End_Date__c</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <elementReference>TodayLess6mo</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Grab_related_ops</targetReference>
            </connector>
            <label>Date Valid</label>
        </rules>
    </decisions>
    <decisions>
        <name>Forecast_Needs_Zeroing</name>
        <label>Forecast Needs Zeroing</label>
        <locationX>710</locationX>
        <locationY>576</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Needs_Zero</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Actual_Revenue__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Actual_Plan_Sales__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Zero_Out_Forecast</targetReference>
            </connector>
            <label>Needs Zero</label>
        </rules>
    </decisions>
    <decisions>
        <name>Opp_in_correct_forecast</name>
        <label>Opp in correct forecast</label>
        <locationX>358</locationX>
        <locationY>792</locationY>
        <defaultConnector>
            <targetReference>Mark_Opp_for_Reset</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Mismatch</defaultConnectorLabel>
        <rules>
            <name>Forecast_Match</name>
            <conditionLogic>2 AND 3 AND (1 OR (4 AND 5) OR (6 AND 7))</conditionLogic>
            <conditions>
                <leftValueReference>ChannelLeadSourceText</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <elementReference>Addition_Loop.LeadSource</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Addition_Loop.CloseDate</leftValueReference>
                <operator>LessThanOrEqualTo</operator>
                <rightValue>
                    <elementReference>$Record.End_Date__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Addition_Loop.CloseDate</leftValueReference>
                <operator>GreaterThanOrEqualTo</operator>
                <rightValue>
                    <elementReference>$Record.Start_Date__c</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>productTypeBucket</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Expansion</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Forecast_Plan__r.Product__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Expansion</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Forecast_Plan__r.Forecast_Channel__r.Partner_Referral_Source__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>forecastChannelLSDtext</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <elementReference>Addition_Loop.LeadSourceDetail__c</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Addition_Loop</targetReference>
            </connector>
            <label>Forecast Match</label>
        </rules>
    </decisions>
    <decisions>
        <name>Opps_Found_Check</name>
        <label>Opps Found Check</label>
        <locationX>446</locationX>
        <locationY>468</locationY>
        <defaultConnector>
            <targetReference>Forecast_Needs_Zeroing</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Opps_In_Collection</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>OppRecs</leftValueReference>
                <operator>IsEmpty</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Addition_Loop</targetReference>
            </connector>
            <label>Opps In Collection</label>
        </rules>
    </decisions>
    <decisions>
        <name>Opps_to_reset_check</name>
        <label>Opps to reset check</label>
        <locationX>182</locationX>
        <locationY>1992</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Opps_Needing_Reset</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>NeedForecastReset</leftValueReference>
                <operator>IsEmpty</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Reset_Opp_Forecasts</targetReference>
            </connector>
            <label>Opps Needing Reset</label>
        </rules>
    </decisions>
    <description>Grabs won opps attached to forecast, loops through and removes them if they don&apos;t belong.  Forecast is recalculated with correct opps.  If there are any bad opps, they&apos;re reset at the end.

Redesigned Sept 2024</description>
    <environments>Default</environments>
    <formulas>
        <name>productTypeBucket</name>
        <dataType>String</dataType>
        <expression>IF(
ISPICKVAL({!Addition_Loop.Product_Type__c}, &quot;Upgrade&quot;)||ISPICKVAL({!Addition_Loop.Product_Type__c}, &quot;Plan Amendment&quot;)||ISPICKVAL({!Addition_Loop.Product_Type__c}, &quot;Add-On Product&quot;),&quot;Expansion&quot;,
IF(ISPICKVAL({!Addition_Loop.Product_Type__c},&quot;PEP&quot;),&quot;401(k)&quot;,TEXT({!Addition_Loop.Product_Type__c})))</expression>
    </formulas>
    <formulas>
        <name>TodayLess6mo</name>
        <dataType>Date</dataType>
        <expression>ADDMONTHS(TODAY(),-6)</expression>
    </formulas>
    <interviewLabel>Forecast | Scheduled | Sync Actual Numbers {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Forecast | Scheduled | Sync Actual Numbers</label>
    <loops>
        <name>Addition_Loop</name>
        <label>Addition Loop</label>
        <locationX>182</locationX>
        <locationY>576</locationY>
        <collectionReference>OppRecs</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>index</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Opp_Removal_Loop</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <description>Loops through index #&apos;s of bad opps</description>
        <name>Opp_Removal_Loop</name>
        <label>Opp Removal Loop</label>
        <locationX>182</locationX>
        <locationY>1284</locationY>
        <collectionReference>oppRemovePositions</collectionReference>
        <iterationOrder>Desc</iterationOrder>
        <nextValueConnector>
            <targetReference>Remove_Bad_Opps_From_Related</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Calculate_Forecast_Actuals</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Grab_related_ops</name>
        <label>Grab related ops</label>
        <locationX>446</locationX>
        <locationY>360</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Opps_Found_Check</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Forecast__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>StageName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Closed Won</stringValue>
            </value>
        </filters>
        <object>Opportunity</object>
        <outputReference>OppRecs</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Amount</queriedFields>
        <queriedFields>LeadSource</queriedFields>
        <queriedFields>CloseDate</queriedFields>
        <queriedFields>Product_Type__c</queriedFields>
    </recordLookups>
    <recordUpdates>
        <name>Commit_forecast_update</name>
        <label>Commit forecast update</label>
        <locationX>50</locationX>
        <locationY>1800</locationY>
        <connector>
            <targetReference>Opps_to_reset_check</targetReference>
        </connector>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Reset_Opp_Forecasts</name>
        <label>Reset Opp Forecasts</label>
        <locationX>50</locationX>
        <locationY>2100</locationY>
        <inputReference>NeedForecastReset</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Zero_Out_Forecast</name>
        <label>Zero Out Forecast</label>
        <locationX>578</locationX>
        <locationY>684</locationY>
        <inputAssignments>
            <field>Actual_Plan_Sales__c</field>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Actual_Revenue__c</field>
            <value>
                <numberValue>0.0</numberValue>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>650</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Current_Forecast_Check</targetReference>
        </connector>
        <object>Forecast__c</object>
        <schedule>
            <frequency>Daily</frequency>
            <startDate>2023-02-08</startDate>
            <startTime>06:00:00.000Z</startTime>
        </schedule>
        <triggerType>Scheduled</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <name>Calculate_Forecast_Actuals</name>
        <label>Calculate Forecast Actuals</label>
        <locationX>182</locationX>
        <locationY>1584</locationY>
        <connector>
            <targetReference>Check_if_forecast_needs_update</targetReference>
        </connector>
        <flowName>Forecast_Autolaunched_Calculate_Actuals</flowName>
        <inputAssignments>
            <name>childOpps</name>
            <value>
                <elementReference>OppRecs</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>forecastRecord</name>
            <value>
                <elementReference>$Record</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <name>bypassOppGet</name>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputAssignments>
        <outputAssignments>
            <assignToReference>$Record</assignToReference>
            <name>forecastRecord</name>
        </outputAssignments>
        <outputAssignments>
            <assignToReference>need2UpdateForecast</assignToReference>
            <name>needsUpdate</name>
        </outputAssignments>
    </subflows>
    <variables>
        <name>ChannelLeadSourceText</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <elementReference>$Record.Forecast_Plan__r.Forecast_Channel__r.Lead_Source__c</elementReference>
        </value>
    </variables>
    <variables>
        <name>forecastChannelLSDtext</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <elementReference>$Record.Forecast_Plan__r.Forecast_Channel__r.Lead_Source_Detail__c</elementReference>
        </value>
    </variables>
    <variables>
        <name>need2UpdateForecast</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <booleanValue>false</booleanValue>
        </value>
    </variables>
    <variables>
        <name>NeedForecastReset</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
    <variables>
        <name>oppRecIndex</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>OppRecs</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Opportunity</objectType>
    </variables>
    <variables>
        <name>oppRemovePositions</name>
        <dataType>Number</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>2</scale>
    </variables>
    <variables>
        <name>TotalAmount</name>
        <dataType>Currency</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
    </variables>
    <variables>
        <name>TotalPlans</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
    </variables>
</Flow>
