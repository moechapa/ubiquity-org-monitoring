<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
<!--  

AJAX  scontrol to update one or many task due dates
 v3.7 add user selection box, new skin
 v3.10 add start end dates
-->
<title>Mass Change Task Due Dates</title>
<link  href="/dCSS/Theme2/default/common.css" type="text/css" media="handheld,print,projection,screen,tty,tv" rel="stylesheet" >
<script language="JavaScript1.2" src="/js/functions.js"></script>
<script src="https://www.salesforce.com/services/lib/ajax/beta3.3/sforceclient.js" type="text/javascript"></script>
<script language="javascript"> 
<!--
var retUrl = "/{!User.Id}";  // where we came from
var dateField = "ActivityDate";
var qr; 
var current_user = "{!User.Id}"; // default
function pageInit() {
	sforceClient.registerInitCallback(main);
	sforceClient.init("{!API.Session_ID}", "{!API.Partner_Server_URL_70}",false);
} 
function main() { // button to ask for task list
	var dh = document.getElementById('divTableHeader');
	dh.innerHTML = "<input id=\"listem\" name=\"listem\" value=\" List Matching Tasks \" "+
		" class=\"btn\" type=\"button\" onclick=\"javascript:setupForm()\" >";
	draw_summary(); 
	//setupForm( "{!User.Id}" ); // default to current running user
}
function setupForm(user_id) { // construct the table and header
	//if (!user_id) { user_id = current_user ; }
	user_id = document.getElementById('tsk1_lkid').value;
	var em = document.getElementById('errorMsgUser');
	if (!user_id) { // 	
		em.style.visibility = 'visible';
		em.innerHTML = "Please select a user";
		return ;
	} else { em.style.visibility = 'hidden'; } 
	
	// two more dates to check, start and end
	var err  = 0;
	var errorMsgStartDate = document.getElementById('errorMsgStartDate');
	var sd = document.getElementById('StartDate');
	if ( sd.value ) { 
		if ( Sforce.Util.ParseDate(trim(sd.value)) == null) { 
			errorMsgStartDate.style.visibility = 'visible';
			errorMsgStartDate.innerHTML =  "Error: You must enter a valid date";
			err = 1;
		} 
	}
	var errorMsgEndDate = document.getElementById('errorMsgEndDate');
	var ed = document.getElementById('EndDate');
	if ( ed.value ) { 
		if ( Sforce.Util.ParseDate(trim(ed.value)) == null) { 
			errorMsgEndDate.style.visibility = 'visible';
			errorMsgEndDate.innerHTML =  "Error: You must enter a valid date";
			err = 1;
		} 
	}
	if (err == 0) {
		errorMsgStartDate.style.visibility = 'hidden';
		errorMsgEndDate.style.visibility = 'hidden';
	} else {
		return; // we sent the error msg
	}
	var div = document.getElementById('divTableHeader');
	div.innerHTML = ""; //clear out old table
	
	var ta = createTag(div,"table",{'class':"list" ,'width':'100%','border':'0','cellspacing':'0','cellpadding':'0'} );
	var tb = createTag(ta,"tbody");
	var tr = createTag(tb,"tr",{'class':"headerRow"});
	createTag(createTag(tr,"th"), "input",
		{'type':'checkbox','onClick':"javascript:SelectChecked(document.forms['editPage'],'ids',this.checked)"})
	createTag(tr,"th",{'nowrap':'nowrap'}).innerHTML="Task";
	createTag(tr,"th",{'nowrap':'nowrap'}).innerHTML="Related To";
	var td = createTag(tr,"th",{'nowrap':'nowrap'});  td.innerHTML="Due Date";
		createTag(td,"img",{'src':"/img/sort_desc_arrow.gif"})
	createTag(tr,"th",{'nowrap':'nowrap'}).innerHTML="Status";

	// todo respect the start and end dates
	var soql =  "Select Id,WhatId,WhoId, Subject, Status, ActivityDate From Task where OwnerId = '" + user_id + "' and isclosed = false " ;
	soql += getDateRange('editPage');
	qr = sforceClient.Query(soql);
	
	if (qr.className != "QueryResult") {
		alert( qr.className + "could not query activities " + qr.toString()); return;
	} 
	if ( qr.size < 1) { 
		var div = document.getElementById('divTableHeader');
		div.innerHTML = "No open tasks found for this user and date range.";
		return ; }
	if (qr.size > 0) {

		qr.records.sort(sortDate); // nice to sort these records by "due date"  ascending
		
		for (var i=0;i<qr.records.length;i++) {
			var row; var atts = new Object();
			if (i==0) { atts["class"] = "dataRow even first";
			} else if (ta.even == true) { atts["class"] = "dataRow even";
			} else {atts["class"] = "dataRow odd"; }
			ta.even = !ta.even;	
			atts["onmouseout"] =  "if (typeof(hiOff) != 'undefined'){hiOff(this);}";
			atts["onmouseover"] = "if (typeof(hiOn) != 'undefined'){hiOn(this);}";
			tr = createTag(tb,"tr",atts);
			
			var	thisrecord = qr.records[i];
			var adate = thisrecord.get("ActivityDate"); 
			// TODO make this date localized...
			if (adate && adate != "" ) { adate = Sforce.Util.ToIsoDate(adate) } else { adate = "&nbsp;";}
			
			var what = get_what_name(thisrecord.get("WhatId"),thisrecord.get("WhoId"))
			var tabCol = [thisrecord.get("Id"), 
				"<a href=\"/"+ thisrecord.get("Id") + "\" target=\"_blank\" >" + thisrecord.get("Subject") + "</a>", 
				what,
				adate, 
				thisrecord.get("Status")];
			
			td = createTag(tr,"td")	
			createTag(td,"input",{'type':'checkbox','name':'ids','id':'ids','value':tabCol[0]});
			for (var j=1;j<tabCol.length;j++) {
				createTag(tr,"td").innerHTML = "&nbsp;" + tabCol[j]; 
			} 	
		}
	}					
}
function getDateRange(form) { var el = document.forms[form].elements;
	var start =null ; 
	var end = null;
	var ret = '';
	for (var i =0 ; i < el.length; i++) { 
		if ( /Start.*Date/.test(	el[i].name) ) { 
			start = el[i];// the start element
		}
		if ( /End.*Date/.test(	el[i].name) ) { 
			end = el[i];// the end element
		}
	} 
	if (start && start.value) {  
		var s = Sforce.Util.ParseDate(trim(start.value));
		if (!s) { alert('could not parse '+start.value) ;}
		else { 
		ret += " and ActivityDate >= " + Sforce.Util.ToIsoDate (s);
		}
	} 
	if (end && end.value) {  
		var s = Sforce.Util.ParseDate(trim(end.value));
		if (!s) { alert('could not parse '+end.value) ;}
		else { 
		ret += " and ActivityDate <= " + Sforce.Util.ToIsoDate (s);
		}
	} 
	//alert(ret);
	return ret;
} 
function clearlist() { 
	// pop up the user picklist box...
	var dh = document.getElementById('divTableHeader');
	dh.innerHTML = "<input id=\"listem\" name=\"listem\" value=\" List Matching Tasks \" "+
		" class=\"btn\" type=\"button\" onclick=\"javascript:setupForm()\" >";
} 
function cancelUpdate() { window.parent.parent.location.href = retUrl; }
function sortDate(a,b) { return a.get(dateField) - b.get(dateField) }
function trim(string) { return string.replace(/(^\xA0*)|(^\s*)|(\s*$)/g,''); } 
function SelectChecked(form, element_name, value) { 
	var i = 0; for (i = 0; i < form.elements.length; i++) { 
		if (form.elements[i].name == element_name) { 
			form.elements[i].checked = value; 
		} 
	} 
} 
function find_user() { return find_one_user( document.getElementById('tsk1').value ) ; } 
function find_one_user(s) { // given a partial name, we need to look up the user 
	// and find exactly one, return the ID, otherwise fail and return null 
	var sstr = "find {" + s + "*} in NAME FIELDS RETURNING User(id,firstname,lastname)";
	var sr = sforceClient.Search(sstr); 
	//alert("search result is "+sr.toString() ); 
	if (sr.className != "SearchResult" || sr.searchRecords.length != 1) { return ""; }
	
	var fulName = sr.searchRecords[0].get("FirstName") + " " + sr.searchRecords[0].get("LastName");
	document.getElementById('tsk1').value = fulName; 
	document.getElementById('tsk1_lkid').value = sr.searchRecords[0].get("Id"); 
	//	alert(sr.searchRecords[0].toString());
	// since we changed users, re-query the task list
	var div = document.getElementById('divTableHeader');
	div.innerHTML = "Working ... ";
	setupForm(sr.searchRecords[0].get("Id"))
} 
function IsChecked(form, element_name, refresh) { 
	var errorMsgDate = document.getElementById('errorMsgDate');
	var err = 0;
	var strActivityDate = "";
	for (i = 0; i < form.elements.length; i++) { 
		if ( form.elements[i].name == 'opp9' ) { 
			strActivityDate = form.elements[i].value ; // grab the date to use
		} 
	}
	if ( strActivityDate == "" ) { 
		errorMsgDate.style.visibility = 'visible';
		errorMsgDate.innerHTML = "Error: You must enter a date";
		err = 1;
	}

	// check that the date entered is a valid date
	var jsActivityDate = Sforce.Util.ParseDate(strActivityDate);
	if ( jsActivityDate == null ) { 
		errorMsgDate.style.visibility = 'visible';
		errorMsgDate.innerHTML = "Error: You must enter a valid date";
		err = 1;
	} 
	
	if (err == 0) {
		errorMsgDate.style.visibility = 'hidden';
	} else {
		//errGeneral.innerHTML = 'Error: Invalid Data. <br>Review all error messages below to correct your data.';
		//errGeneral.style.visibility = 'visible';
		return false;
	}
	var updateObjects = new Array();
	for (i = 0; i < form.elements.length; i++) { 
		if ((form.elements[i].name == element_name) && (form.elements[i].checked)) { 
			var bean = new Sforce.Dynabean("task");
			bean.set("Id",form.elements[i].value); // the ID is stored in the form element value
			bean.set("ActivityDate", jsActivityDate);
			updateObjects.push(bean);
		}
	}

	if (updateObjects.length > 0) { 
		var x = true; // window.confirm("Are you sure you want to update "+ updateObjects.length +" record(s) ?"); 
		if (x) { 
			var sr = sforceClient.Update(updateObjects);
			// check the return array value here !!
			var failed = 0; 
			
			for (i=0 ; i < sr.length; i++) { 
				if (sr[i].success == false) { failed++; } 
			}
			if ( failed > 0 ) { 
				alert( "Could not udpate one or more of the opportunities!");
			}
			if ( refresh == null ) { // go back
				window.parent.parent.location.href = retUrl; 
			} else { // just refresh
				window.parent.parent.location.href = window.parent.parent.location.href; 
			} 
		} 
	} else { 
		errorMsgDate.style.visibility = 'visible';
		errorMsgDate.innerHTML = "Error: You must select one or more tasks";
		err = 1;

		// should use the error msg area TODO
//		alert("No tasks selected, no update performed"); 
		// window.parent.parent.location.href = retUrl; 
	} 
} 
function get_what_name(id,id2) { // given an id, fetch the name
	var table; var qr
	if (!id || id=="") id = id2;
	if (!id || id=="") return "&nbsp;";
	switch(id.substr(0,3)) { 
		case "001": qr = sforceClient.Query("select name from Account where id = '"+id+"'");break;
		case "006": qr = sforceClient.Query("select name from Opportunity where id = '"+id+"'");break;
		case "003": qr = sforceClient.Query("select firstname, lastname from Contact where id = '"+id+"'");break;
		default: return "&nbsp;";
	}
	if (qr.className != "QueryResult") return "&nbsp;";
	if (qr.size != 1) return "&nbsp;";
	switch (id.substr(0,3)) { 
		case "001":
		case "006": return qr.records[0].get("Name"); break;
		case "003": return qr.records[0].get("FirstName") + " " +qr.records[0].get("LastName"); break;
		default : return "&nbsp;";
	}
	return "&nbsp;";
}
var sapp = new Sforce.Application(); // to get browser version
function makeTable(p) {
	var table = createTag(p,"table",{ 'class':'list','width':'100%','border':'0','cellspacing':'0','cellpadding':'0'} );
	table.tbody = createTag(table,'tbody');
	return table
}
function makeRow(atts) { return createTag(null,'TR',atts); }
function createTag(parent, name, keyvalPairs) {
	var ret; 
	if (sapp.get_type() == Sforce.Application.Type.InternetExplorer) {
		var trTag = "<"+name+" ";
		for (key in keyvalPairs) {
				trTag += key + "=\"" + keyvalPairs[key] + "\"";
		}
		trTag += ">";
		ret = document.createElement(trTag);
	} else { 
		ret = document.createElement(name);
		for (key in keyvalPairs) {
			ret.setAttribute(key, keyvalPairs[key]);
		}
	} 
	if (parent) parent.appendChild(ret);
	ret.active = false;
	return ret;
}
function new_user() { } 
function draw_summary (cl) { 
	table = makeTable(document.getElementById("header"));
	var tr = createTag(table.tbody,'tr');
	createTag(tr,"td", {'class':'labelCol requiredInput'} ).innerHTML = "<label for=\"tsk1\">User</label>";
	
	createTag(tr,"td", {'class':'dataCol'} ).innerHTML = 
 		"<div class=\"requiredInput\"><div class=\"requiredBlock\"></div>"+
		"<input name=\"tsk1_lkid\" id=\"tsk1_lkid\" value=\"{!User.Id}\" type=\"hidden\">"+
		"<input name=\"tsk1_lkold\" id=\"tsk1_lkold\" value=\"\" type=\"hidden\">"+
		"<input name=\"tsk1_lktp\" id=\"tsk1_lktp\" value=\"005\" type=\"hidden\">"+
		"<input name=\"tsk1_lspf\" id=\"tsk1_lspf\" value=\"0\" type=\"hidden\">"+
		"<input name=\"tsk1_mod\" id=\"tsk1_mod\" value=\"0\" type=\"hidden\">"+
		"<span class=\"lookupInput\"><input value=\"{!User.Name}\" tabindex=\"1\" maxlength=\"80\" 	"+
		"onchange=\"document.getElementById('tsk1_lkid').value='';document.getElementById('tsk1_mod').value='1';clearlist();\" "+
		"id=\"tsk1\" size=\"20\" name=\"tsk1\" type=\"text\" >"+
		"<a href=\"JavaScript: openLookup('/_ui/common/data/LookupPage?lknm=tsk1&lkfm=editPage&lktp=' + document.getElementById('tsk1_lktp').value,670,document.getElementById('tsk1_mod').value,'&lksrch=' + escapeUTF(document.getElementById('tsk1').value),'maxw');clearlist();\" tabindex=\"1\" title=\"Assigned To Lookup (New Window)\" onclick=\"setLastMousePosition(event)\" id=\"tsk1_lkwgt\"><img src=\"/s.gif\" alt=\"Assigned To Lookup (New Window)\" class=\"lookupPopup\"></a></span>"+
		"<span class=\"errorMsg\" id=\"errorMsgUser\"></span></div>";

	createTag(tr,"td").innerHTML = "&nbsp;";
	createTag(tr,"td").innerHTML = "&nbsp;";

/*
	createTag(tr,"td" , {'class':'pbButton'} ).innerHTML = 
		"<input name=\"changeuser\" value=\" Change User \" class=\"btn\" type=\"button\" onclick=\"javascript:change_user()\" >"+
		"<div class=errorMsg id=error_General ></div>";
<span class="errorMsg" id="errorMsgUser"></span></div>
*/
	tr = createTag(table.tbody,'tr');
	createTag(tr,"td", {'class':'labelCol requiredInput'} ).innerHTML = "<label for=\"StartDate\">Start Date</label>";
		
	// this could be re-factored into createTag() statements.
	var td = createTag(tr,"td", {'class':'dataCol'} );
	td.innerHTML = 
	//"<div class=\"requiredInput\"><div class=\"requiredBlock\"></div>"+
	"<span class=\"dateInput\"><input value=\"{!Today}\""+
	"id=\"StartDate\" size=\"12\" name=\"StartDate\" type=\"text\" onchange=\"clearlist();\" >"+
	"<a href=\"javascript:openPopupFocus('/home/calendar.jsp?form=editPage&field=StartDate&mo=0', '_blank', 186, 170, 'width=186,height=170,resizable=yes,toolbar=no,status=no,scrollbars=no,menubar=no,directories=no,location=no,dependant=yes', true, true);clearlist();\" class=\"datePicker\" title=\"Pick A Date (New Window)\" onclick=\"setLastMousePosition(event)\" onchange=\"document.editPage.focusThisFieldOnLoad.value='StartDate';document.editPage.submit();\" id=\"StartDatePopCal\"><img src=\"/s.gif\" alt=\"Pick A Date (New Window)\" class=\"datePickerIcon\"></a></span>"+
	"<span class=\"errorMsg\" id=\"errorMsgStartDate\"></span>"//</div>";

	//td.innerHTML += ""; 
	createTag(tr,"td", {'class':'labelCol requiredInput'} ).innerHTML = 
		"<label for=\"EndDate\">End Date</label>";
	td = createTag(tr,"td", {'class':'data2Col col02'} );
	td.innerHTML = 
	//"<div class=\"requiredInput\"><div class=\"requiredBlock\"></div>"+
	"<span class=\"dateInput\"><input value=\"\""+
	"id=\"EndDate\" size=\"12\" name=\"EndDate\" type=\"text\" onchange=\"clearlist();\" >"+
	"<a href=\"javascript:openPopupFocus('/home/calendar.jsp?form=editPage&field=EndDate&mo=0', '_blank', 186, 170, 'width=186,height=170,resizable=yes,toolbar=no,status=no,scrollbars=no,menubar=no,directories=no,location=no,dependant=yes', true, true);clearlist();\" class=\"datePicker\" title=\"Pick A Date (New Window)\" onclick=\"setLastMousePosition(event)\" onchange=\"document.editPage.focusThisFieldOnLoad.value='EndDate';document.editPage.submit();\" id=\"EndDatePopCal\"><img src=\"/s.gif\" alt=\"Pick A Date (New Window)\" class=\"datePickerIcon\"></a></span>"+
	"<span class=\"errorMsg\" id=\"errorMsgEndDate\"></span>"//</div>";
	
/*	var div1 = createTag(td,"div",{'class':'requiredInput'}); 
		createTag(div1,"div",{'class':'requiredBlock'}); 
	createTag(td,"span",{'class':'dateInput'}).innerHTML = 
	"<input value=\"{!Today}\" onchange=\"document.editPage.focusThisFieldOnLoad.value='StartDate';document.editPage.submit();\" "+
	"id=\"StartDate\" size=\"12\" name=\"StartDate\" type=\"text\"><a href=\"javascript:openPopupFocus('/home/calendar.jsp?sbmt=top.window.opener.document.editPage.focusThisFieldOnLoad.value%3D%22StartDate%22%3Btop.window.opener.pickSubmit%28%22editPage%22%2C%22StartDate%22%2Cv%2C+true%29%3B&form=editPage&field=StartDate&mo=0', '_blank', 186, 170, 'width=186,height=170,resizable=yes,toolbar=no,status=no,scrollbars=no,menubar=no,directories=no,location=no,dependant=yes', true, true);\" class=\"datePicker\" title=\"Pick A Date (New Window)\" onclick=\"setLastMousePosition(event)\" onchange=\"document.editPage.focusThisFieldOnLoad.value='StartDate';document.editPage.submit();\" id=\"StartDatePopCal\"><img src=\"/s.gif\" alt=\"Pick A Date (New Window)\" class=\"datePickerIcon\"></a>"
*/	

}


//--> 
</script>
</head>
<body onload="pageInit()" class="home  editPage">
<a name="skiplink">
<img src="/s.gif" height='1' width='1' alt="Content Starts Here" class="skiplink"></a>
<form name="editPage" id="editPage">

<div class="bPageTitle">
<div class="ptBody secondaryPalette">
	<div class="content">
	<img src="/s.gif" alt="Home"  class="pageTitleIcon">
	<h1 class="pageType noSecondHeader">
	Task Update Due Dates<span  class="titleSeparatingColon">:</span></h1>
	<!-- <h2 class="pageDescription"></h2> <div class="blank">&nbsp;</div>-->
	</div>
	<div class="ptBreadcrumb"></div>
</div>


<div class="listCase">
	<div class="bPageBlock secondaryPalette">
		<div class="pbHeader"><TABLE ><tbody>
			<TR><TD class="pbTitle"><b>Select user and date range for task list</b></TD>
			</tr></tbody></TABLE>
		</div>
		<div class="pbBody" id="header" name="header">
		<!-- draw_summary() works here -->
		</div> 
		<div class="pbFooter secondaryPalette"> <div class="bg"></div></div> 
	</div>
</div>

Select one or more tasks, enter a new Due Date, click Update Due Dates

<div class="bPageBlock bEditBlock secondaryPalette" id="ep">
<div class="pbHeader">
	<TABLE  cellpadding="0" cellspacing="0" border="0">
	<TR> 
	<TD class="">
		<!-- <img src="/s.gif" alt="" title="" width=1 height=1 class="minWidth">
		 <h3 class="mainTitle">New Due Date</h3>
		<div class="requiredInput"><div class="requiredBlock"></div>
		<input name="opp9" id="opp9" size="12" tabindex="7" type="text" >
		<a href="javascript:openPopupFocus('/home/calendar.jsp?form=editPage&field=opp9&mo=0', '_blank', 193, 148, 'width=193,height=148,resizable=yes,toolbar=no,status=no,scrollbars=no,menubar=no,directories=no,location=no,dependant=yes', true, true);" tabindex="7" onclick="setLastMousePosition(event)"><img src="/img/date_picker.gif" alt="Pick A Date" title="Pick A Date" border="0" height="16" width="24"></a>
		<span class="errorMsg" id="errorMsgDate"></span>
	</div>-->
	</TD>
<!-- 
	<td class="dataCol col02"><div class="requiredInput"><div class="requiredBlock"></div>
		<input name="tsk1_lkid" id="tsk1_lkid" value="" type="hidden">
		<input name="tsk1_lkold" id="tsk1_lkold" value="" type="hidden">
		<input name="tsk1_lktp" id="tsk1_lktp" value="005" type="hidden">
		<input name="tsk1_lspf" id="tsk1_lspf" value="0" type="hidden">
		<input name="tsk1_mod" id="tsk1_mod" value="0" type="hidden">
		<span class="lookupInput">
			<input value="{!User.Name}" tabindex="1" maxlength="80" 
onchange="document.getElementById('tsk1_lkid').value='';document.getElementById('tsk1_mod').value='1';find_user();" 
			id="tsk1" size="20" name="tsk1" type="text" >
			<a href="JavaScript: openLookup('/_ui/common/data/LookupPage?lknm=tsk1&lkfm=editPage&lktp=' + document.getElementById('tsk1_lktp').value,670,document.getElementById('tsk1_mod').value,'&lksrch=' + escapeUTF(document.getElementById('tsk1').value),'maxw');find_user();" tabindex="1" title="Assigned To Lookup (New Window)" onclick="setLastMousePosition(event)" id="tsk1_lkwgt"><img src="/s.gif" alt="Assigned To Lookup (New Window)" class="lookupPopup"></a>
		</span>
		
	</td>
 -->	
	<td class="labelCol" width="17%" >New Due Date: </td><td>
		<div class="requiredInput"><div class="requiredBlock"></div>
		<input name="opp9" id="opp9" size="12" tabindex="7" type="text" >
		<a href="javascript:openPopupFocus('/home/calendar.jsp?form=editPage&field=opp9&mo=0', '_blank', 193, 148, 'width=193,height=148,resizable=yes,toolbar=no,status=no,scrollbars=no,menubar=no,directories=no,location=no,dependant=yes', true, true);" tabindex="7" onclick="setLastMousePosition(event)"><img src="/img/date_picker.gif" alt="Pick A Date" title="Pick A Date" border="0" height="16" width="24"></a>
		<span class="errorMsg" id="errorMsgDate"></span>
		</div>
	</td>

	<TD class="pbButton">
		<input name="save1" value=" Update Task Due Dates " class="btn" type="button" 
			onclick="javascript: IsChecked(document.forms['editPage'],'ids','refresh')" >	
		<div class=errorMsg id="error_General"></div>
		</TD>
	 </TR>
	</TABLE>
	</DIV>
	
	<div id="divTableHeader" class="pbBody"> <!-- the body --></div>
	
	<div class="pbFooter secondaryPalette"> <div class="bg"></div></div> 
</div>
</form>
</body>
</html>